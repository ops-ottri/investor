<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Ottri Investor Update</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- GViz perf hints -->
  <link rel="dns-prefetch" href="https://docs.google.com" />
  <link rel="preconnect" href="https://docs.google.com" crossorigin />

  <!-- Inter (UI) + Lato (titles) -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Lato:wght@800;900&display=swap" rel="stylesheet" />

  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Preload your stencil font (same folder as index.html) -->
  <link rel="preload" as="font" href="L-7%20Stencil.ttf" type="font/ttf" crossorigin />

  <style>
    /* ===== Custom stencil font ===== */
    @font-face {
      font-family: "L7Stencil";
      src: url("L-7%20Stencil.ttf") format("truetype");
      font-display: swap;
      font-weight: 400;
      font-style: normal;
    }

    /* ===== Base / Background fix ===== */
    html, body { height: 100%; }
    body {
      font-family: "Inter", sans-serif;
      color: #ffffff;
      background:
        radial-gradient(1200px 600px at 15% -10%, rgba(76,36,159,0.35) 0%, rgba(76,36,159,0) 45%),
        radial-gradient(1000px 500px at 85% 0%,   rgba(217,70,239,0.20) 0%, rgba(217,70,239,0) 50%),
        #030014;
      background-repeat: no-repeat;
      background-attachment: fixed;
    }

    .section-eyebrow { color: #9378ff; font-weight: 600; letter-spacing: 0.1em; text-transform: uppercase; }

    .loader { border: 4px solid rgba(255, 255, 255, 0.2); border-top: 4px solid #9378ff; border-radius: 50%;
      width: 40px; height: 40px; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0); } 100% { transform: rotate(360deg); } }

    .title-gradient { background: linear-gradient(90deg, #F97316, #D946EF, #8B5CF6);
      -webkit-background-clip: text; background-clip: text; color: transparent; }

    .section-separator { position: relative; }
    .section-separator::before {
      content: ""; position: absolute; top: 0; left: 50%; transform: translateX(-50%);
      width: 90%; max-width: 1280px; border-top: 1px solid rgba(255, 255, 255, 0.1);
    }
    @keyframes pulse { 0%,100%{opacity:1;transform:scale(1);} 50%{opacity:.7;transform:scale(1.1);} }

    /* ===== Mobile accordion ===== */
    @media (max-width: 768px) {
      .section-header-mobile { cursor: pointer; }
      .section-content { max-height: 0; overflow: hidden; transition: max-height .45s ease; }
      .section-content.expanded { max-height: 5000px; }
      .chevron-indicator { transition: transform .3s ease; animation: pulse 2.5s infinite cubic-bezier(.4,0,.6,1); }
      .section-header-mobile.expanded .chevron-indicator { transform: rotate(180deg); animation: none; }
    }

    /* ===== Titles (Lato) + first-letter stencil ===== */
    .hero-title, .section-title { font-family: "Lato", sans-serif; font-weight: 800; -webkit-font-smoothing: antialiased; text-rendering: optimizeLegibility; }
    .initial {
      font-family: "L7Stencil", "Lato", sans-serif;
      font-weight: 700;
      filter:
        drop-shadow( 0.35px  0        0 currentColor)
        drop-shadow(-0.35px  0        0 currentColor)
        drop-shadow( 0        0.35px  0 currentColor)
        drop-shadow( 0       -0.35px  0 currentColor)
        drop-shadow( 0.25px   0.25px  0 currentColor)
        drop-shadow(-0.25px   0.25px  0 currentColor)
        drop-shadow( 0.25px  -0.25px  0 currentColor)
        drop-shadow(-0.25px  -0.25px  0 currentColor);
    }

    p.text-indigo-300 { white-space: pre-line; }

    /* ===== KPI Widget styles ===== */
    .kpi-widget {
      --hover-gradient: linear-gradient(120deg, #8B5CF6, #A78BFA);
      background: linear-gradient(145deg, rgba(255,255,255,0.05), rgba(255,255,255,0.02));
      backdrop-filter: blur(12px);
      border-radius: 1rem;
      padding: 1.5rem;
      border: 1px solid rgba(255,255,255,0.1);
      position: relative;
      overflow: hidden;
      transition: transform .3s ease, box-shadow .3s ease;
      transform: translateY(0);
      opacity: 0;
      animation: fadeInUp .6s ease-out forwards;
    }
    .kpi-widget:hover { transform: translateY(-8px); box-shadow: 0 20px 40px rgba(0,0,0,0.4); }
    .kpi-widget::before {
      content: "";
      position: absolute; inset: 0; border-radius: 1rem; padding: 2px;
      background: var(--hover-gradient);
      -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
      -webkit-mask-composite: destination-out; mask-composite: exclude;
      opacity: 0; transition: opacity .4s ease-in-out;
    }
    .kpi-widget:hover::before { opacity: 1; }
    @keyframes fadeInUp { from { opacity: 0; transform: translateY(25px); } to { opacity: 1; transform: translateY(0); } }

    /* ===== Fixed iPhone mockup hover ===== */
    .iphone-mockup {
        position: relative;
        width: 280px;
        height: 573px;
        margin: 0 auto;
        background-color: #1a1a1a;
        border-radius: 44px;
        border: 1px solid #444;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5),
                    inset 0 0 10px rgba(0,0,0,0.6);
        padding: 14px;
        overflow: visible;                /* prevent clipping */
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    .iphone-mockup:hover {
        transform-origin: center center;  /* smooth scaling */
        transform: translateY(-10px) scale(1.02);
        box-shadow: 0 35px 60px -15px rgba(147, 120, 255, 0.3);
    }
    .iphone-screen {
        background-color: #000;
        width: 100%;
        height: 100%;
        border-radius: 30px;
        overflow: hidden;
        position: relative;
    }
    .iphone-screen img, .iphone-screen iframe {
        width: 100%;
        height: 100%;
        object-fit: cover;
        border: none;
    }
    .iphone-notch {
        position: absolute;
        top: 14px;
        left: 50%;
        transform: translateX(-50%);
        width: 140px;
        height: 24px;
        background-color: #1a1a1a;
        border-radius: 0 0 16px 16px;
        z-index: 2;
    }
    .scroll-container { -ms-overflow-style: none; scrollbar-width: none; }
    .scroll-container::-webkit-scrollbar { display: none; }

    @media print { body { display: none !important; } }
  </style>
</head>
<body class="antialiased" style="overflow: hidden;">

  <div id="password-modal" class="fixed inset-0 bg-black bg-opacity-80 items-center justify-center z-50 p-4 hidden">
    <div class="bg-[#110d24] border border-white/10 rounded-2xl p-8 max-w-sm w-full text-center shadow-2xl">
      <h2 class="text-2xl font-bold text-white">Access Required</h2>
      <p class="mt-2 text-gray-400">Please enter the password to view this update.</p>
      <input type="password" id="password-input" class="mt-6 w-full bg-gray-900/50 border border-white/20 rounded-lg p-3 text-white text-center focus:ring-2 focus:ring-[#9378ff] focus:outline-none" placeholder="••••••••" autocomplete="current-password" />
      <p id="password-error" class="text-red-400 text-sm mt-2 h-5"></p>
      <button id="unlock-button" class="mt-4 w-full bg-[#9378ff] hover:bg-[#8162ff] text-white font-bold py-3 px-4 rounded-lg transition-all duration-200 flex items-center justify-center">
        <span id="unlock-text">Unlock</span>
        <div id="unlock-spinner" class="loader w-6 h-6 border-2 hidden" aria-hidden="true"></div>
      </button>
    </div>
  </div>

  <header id="header-container" class="hidden"></header>
  <main id="content-container" class="hidden"></main>
  <footer id="footer-container" class="hidden"></footer>

<script>
/* =======================
    CONFIG
    ======================= */
const SHEET_ID = "1sJQIQuUWe0sOrytSmJj0siTsuAR5ZNL2MEpcZsyBYUc";

/* Candidate tabs in preferred order. We'll filter out hidden ones. */
const TAB_ORDER = ["title","intro","team","momentum","product","market","roadmap","partners","vision","footer"];
const TITLE_TABS  = ["title","hero","header"];
const FOOTER_TABS = ["footer","foot","end"];
const PASSWORD_TAB_CANDIDATES = ["passwords","Passwords","password","Password","pw","PW"];
const VISIBLE_TABS_CANDIDATES = ["visible_tabs","Visible_Tabs","visible","Visible"];

const $ = (sel) => document.querySelector(sel);
const GRADIENT_RE = /\*(.*?)\*/g;

/* =======================
    Helpers
    ======================= */
function applyGradient(text) {
  return (!text || typeof text !== "string")
    ? ""
    : text.replace(GRADIENT_RE, '<span class="title-gradient">$1</span>');
}

function gvizUrl(name, tq = "select *") {
  return `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(name)}&tq=${encodeURIComponent(tq)}`;
}
function parseGViz(txt) {
  const s = txt.indexOf("{");
  const e = txt.lastIndexOf("}");
  if (s === -1 || e === -1) throw new Error("Bad GViz response");
  const json = JSON.parse(txt.slice(s, e + 1));
  const rows = (json.table && json.table.rows) ? json.table.rows : [];
  return rows.map((r) => (r.c || []).map((c) => (c && c.v != null ? c.v : null)));
}
async function fetchTab(name, tq) {
  const res = await fetch(gvizUrl(name, tq), { cache: "no-store" });
  if (!res.ok) throw new Error(`Fetch failed for tab "${name}" (${res.status})`);
  const text = await res.text();
  return parseGViz(text);
}

/* =======================
    Hidden tabs logic
    ======================= */
/*
  GViz doesn't expose the Sheet "hidden" flag. We support:
  1) Control tab "visible_tabs" listing tabs to show (column A, one per row).
  2) Naming convention: any tab starting with "_" or "." is treated as hidden.
*/
function isNameHiddenLike(name){
  if(!name) return true;
  const n = String(name).trim();
  return n.startsWith("_") || n.startsWith(".");
}

async function getVisibleTabNames(){
  // First try control tab
  for(const ctl of VISIBLE_TABS_CANDIDATES){
    try{
      const rows = await fetchTab(ctl, "select A");
      const listed = rows.slice(0).map(r => String(r?.[0] ?? "").trim()).filter(Boolean);
      // If there are any non-empty values, use this allowlist (case-insensitive)
      if(listed.length){
        const allow = new Set(listed.map(s => s.toLowerCase()));
        return TAB_ORDER.filter(t => allow.has(t.toLowerCase()));
      }
    }catch(e){ /* ignore and try next */ }
  }
  // Fallback: drop any name that looks hidden by prefix
  return TAB_ORDER.filter(t => !isNameHiddenLike(t));
}

/* =======================
    Passwords (fail-open)
    ======================= */
async function fetchPasswordSetSafe() {
  const set = new Set();
  for (const name of PASSWORD_TAB_CANDIDATES) {
    try {
      const rows = await fetchTab(name, "select A");
      for (let i = 1; i < rows.length; i++) {
        const v = rows[i] && rows[i][0] != null ? String(rows[i][0]).trim() : "";
        if (v) set.add(v);
      }
      return set;
    } catch (e) {
      continue;
    }
  }
  return set;
}

/* =======================
    Load all content tabs (skipping hidden)
    ======================= */
async function loadFromSheets() {
  console.info("[Ottri] Loading content tabs…");
  const names = (await getVisibleTabNames()).map(n => n.toLowerCase());

  const results = {};
  await Promise.all(
    names.map(async (n) => {
      try { results[n] = await fetchTab(n); }
      catch (e) { console.warn("[Ottri] Tab failed:", n, e); results[n] = []; }
    })
  );

  const titleName  = names.find((n) => TITLE_TABS.includes(n))  || names[0];
  const footerName = names.find((n) => FOOTER_TABS.includes(n)) || names[names.length - 1];

  return {
    titleData:  { name: titleName,  data: results[titleName]  || [] },
    footerData: { name: footerName, data: results[footerName] || [] },
    contentData: names.filter((n) => n !== titleName && n !== footerName).map((n) => ({ name: n, data: results[n] || [] }))
  };
}

/* =======================
    Sections
    ======================= */
function renderHeroSection(sheet) {
  const d = sheet.data || [];
  if (d.length < 2) return "";
  const r = d[1] || [];
  const title    = String(r[0] ?? "");
  const subtitle = String(r[1] ?? "");
  const logo     = String(r[2] ?? "");

  let h = '<div class="text-center py-16 sm:py-20 px-6 lg:px-8">';
  if (logo)    h += `<img class="max-h-48 w-auto mx-auto mb-8" src="${logo}" alt="Ottri Logo" loading="lazy" />`;
  if (title)   h += `<h1 class="hero-title text-4xl font-bold tracking-tight sm:text-6xl leading-snug sm:leading-snug">${applyGradient(title)}</h1>`;
  if (subtitle)h += `<p class="mt-4 text-lg leading-8 text-gray-300">${applyGradient(subtitle)}</p>`;
  h += "</div>";
  return h;
}

function renderStandardSection(sheet) {
  const d = sheet.data || [];
  if (d.length < 2) return "";
  const hdr  = d[1] || [];
  const eyebrow = String(hdr[0] ?? "");
  const title   = String(hdr[1] ?? "");
  const desc    = String(hdr[7] ?? "");
  const paras   = [];
  for (let i = 1; i < d.length; i++) {
    if (d[i] && d[i][2] != null && String(d[i][2]).trim() !== "") {
      paras.push(String(d[i][2]));
    }
  }

  let h = '<div class="max-w-4xl mx-auto text-center py-16 sm:py-24 px-6 lg:px-8">';
  h += '<div class="section-header-mobile">';
  if (eyebrow) h += `<p class="section-eyebrow mb-4">${applyGradient(eyebrow)}</p>`;
  if (title)   h += `<h2 class="section-title text-4xl md:text-5xl font-extrabold tracking-tight">${applyGradient(title)}</h2>`;
  if (desc)    h += `<p class="mt-4 max-w-3xl mx-auto text-lg text-gray-300">${applyGradient(desc)}</p>`;
  h += '<div class="md:hidden flex justify-center mt-6"><svg class="chevron-indicator w-6 h-6 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg></div>';
  h += "</div><div class=\"section-content\">";
  paras.forEach((p) => { h += `<p class="mt-6 max-w-2xl mx-auto text-lg text-gray-300 text-center">${applyGradient(p).replace(/\n/g, "<br/>")}</p>`; });
  h += "</div></div>";
  return h;
}

function renderFooterSection(sheet) {
  const d = sheet.data || [];
  if (d.length < 2) return "";
  const r = d[1] || [];
  const eyebrow = String(r[0] ?? "");
  let body = "";
  [1,2,3].forEach((i) => {
    const v = String(r[i] ?? "");
    if (v) body += `<p class="mt-4 text-md text-gray-400">${applyGradient(v).replace(/\n/g, "<br/>")}</p>`;
  });
  let h = '<div class="section-separator py-16 sm:py-24 px-6 lg:px-8"><div class="max-w-4xl mx-auto text-center">';
  if (eyebrow) h += `<p class="section-eyebrow mb-4">${applyGradient(eyebrow)}</p>`;
  h += body + "</div></div>";
  return h;
}

/* Product section (auto detect "link" column) */
function renderProductSection(sheet) {
  const d = sheet.data || [];
  if (d.length < 2) return "";

  const hdrRow = (d[0] || []).map(v => String(v ?? "").toLowerCase());
  const hdr = d[1] || [];
  const eyebrow = String(hdr[0] ?? "");
  const title = String(hdr[1] ?? "");
  const desc = String(hdr[7] ?? "");

  // Find the "link" column by header name; fall back to I (8), then D (3)
  let linkCol = hdrRow.indexOf("link");
  if (linkCol === -1) linkCol = (d[0].length > 8 ? 8 : 3);

  const links = d.slice(2)
    .map(r => r && String(r[linkCol] ?? "").trim())
    .filter(Boolean);

  if (links.length === 0) return "";

  let h = '<div class="max-w-7xl mx-auto text-center py-16 sm:py-24 px-6 lg:px-8 overflow-hidden">';
  h += '<div class="section-header-mobile">';
  if (eyebrow) h += `<p class="section-eyebrow mb-4">${applyGradient(eyebrow)}</p>`;
  if (title) h += `<h2 class="section-title text-4xl md:text-5xl font-extrabold tracking-tight">${applyGradient(title)}</h2>`;
  if (desc) h += `<p class="mt-4 max-w-3xl mx-auto text-lg text-gray-300">${applyGradient(desc)}</p>`;
  h += '<div class="md:hidden flex justify-center mt-6"><svg class="chevron-indicator w-6 h-6 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg></div>';
  h += '</div><div class="section-content">';

  h += '<div class="mt-20 flex flex-nowrap lg:flex-wrap justify-start lg:justify-center items-center gap-x-8 gap-y-12 overflow-x-auto scroll-container pb-8 -mx-6 px-6">';
  links.forEach((link, index) => {
    h += `
      <div class="iphone-mockup flex-shrink-0">
        <div class="iphone-notch"></div>
        <div class="iphone-screen">`;
    if (link.toLowerCase().endsWith('.pdf')) {
      h += `<iframe src="${link}" title="Platform Screen ${index + 1}"></iframe>`;
    } else {
      h += `<img src="${link}" alt="Platform Screenshot ${index + 1}" onerror="this.onerror=null;this.src='https://placehold.co/375x812/030014/9378ff?text=Image+Failed';">`;
    }
    h += `
        </div>
      </div>`;
  });
  h += '</div>';

  h += '</div></div>';
  return h;
}

/* =======================
    Assemble & render
    ======================= */
function renderPage(res) {
  const main = $("#content-container");
  const head = $("#header-container");
  const foot = $("#footer-container");

  if (res.titleData) head.innerHTML = renderHeroSection(res.titleData);

  main.innerHTML = "";
  if (res.contentData && res.contentData.length) {
    res.contentData.forEach((sheet) => {
      const name = (sheet.name || "").toLowerCase();
      let html = "";
      if (name.includes("product")) html = renderProductSection(sheet);
      else html = renderStandardSection(sheet);
      const wrapper = document.createElement("div");
      wrapper.className = "section-wrapper section-separator";
      wrapper.innerHTML = html;
      main.appendChild(wrapper);
    });
  }
  if (res.footerData) foot.innerHTML = renderFooterSection(res.footerData);

  head.classList.remove("hidden");
  main.classList.remove("hidden");
  foot.classList.remove("hidden");
}

/* =======================
    Unlock flow
    ======================= */
async function doUnlock() {
  const input = $("#password-input");
  const err   = $("#password-error");
  const btn   = $("#unlock-button");
  const txt   = $("#unlock-text");
  const spin  = $("#unlock-spinner");

  const pw = (input.value || "").trim();
  if (!pw) { err.textContent = "Please enter a password."; return; }

  err.textContent = "";
  txt.classList.add("hidden");
  spin.classList.remove("hidden");
  btn.disabled = true;

  try {
    const pwSet = await fetchPasswordSetSafe();
    if (pwSet.size > 0 && !pwSet.has(pw)) {
      err.textContent = "Invalid password. Please try again.";
      return;
    }
    $("#password-modal").classList.add("hidden");
    document.body.style.overflow = "auto";
    const data = await loadFromSheets();
    renderPage(data);
  } catch (e) {
    console.error("[Ottri] Unlock/render error:", e);
    document.body.innerHTML = `<div class="h-screen w-screen flex flex-col items-center justify-center bg-[#030014] text-white p-8 text-center" style="background-color: #030014;">
        <h1 class="text-3xl font-bold text-red-400">An Error Occurred</h1>
        <p class="mt-4 text-lg text-gray-300">Could not load the investor update. The data sheet may be misconfigured.</p>
        <p class="mt-2 text-sm text-gray-500">Please check the developer console for more details.</p>
    </div>`
  } finally {
    txt.classList.remove("hidden");
    spin.classList.add("hidden");
    btn.disabled = false;
  }
}

document.addEventListener("DOMContentLoaded", async () => {
  console.info("[Ottri] DOM ready");
  $("#unlock-button").addEventListener("click", doUnlock);
  $("#password-input").addEventListener("keypress", (e) => { if (e.key === "Enter") doUnlock(); });

  try {
    const pwSet = await fetchPasswordSetSafe();
    if (pwSet.size === 0) {
      $("#password-modal").classList.add("hidden");
      document.body.style.overflow = "auto";
      const data = await loadFromSheets();
      renderPage(data);
    } else {
      const modal = $("#password-modal");
      modal.classList.remove("hidden");
      modal.classList.add("flex");
      $("#password-input").focus();
    }
  } catch (e) {
    console.error("[Ottri] Initialization error:", e);
    document.body.innerHTML = `<div class="h-screen w-screen flex flex-col items-center justify-center bg-[#030014] text-white p-8 text-center" style="background-color: #030014;">
        <h1 class="text-3xl font-bold text-red-400">An Error Occurred</h1>
        <p class="mt-4 text-lg text-gray-300">Could not initialize the page. Please try again later.</p>
        <p class="mt-2 text-sm text-gray-500">Please check the developer console for more details.</p>
    </div>`
  }
});
</script>
</body>
</html>
